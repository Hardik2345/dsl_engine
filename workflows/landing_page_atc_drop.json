 {
  "workflow_id": "landing_page_atc_drop",
  "workflow_type": "root_cause_analysis",
  "description": "RCA workflow for landing page mismatch - sessions stable but ATC rate drops",
  "version": "1.0",

  "trigger": {
    "type": "alert",
    "metric": "atc_rate",
    "condition": {
      "operator": "<",
      "delta_pct": -15
    },
    "window": {
      "type": "rolling",
      "duration": "1h"
    }
  },

  "context": {
    "tenant_id": "{{tenant_id}}",
    "brand_id": "{{brand_id}}",
    "baseline_window": "previous_day_same_hour",
    "currency": "{{brand_currency}}"
  },

  "nodes": [
    {
      "id": "data_sanity_check",
      "type": "validation",
      "checks": [
        { "field": "sessions", "condition": "current > 0" },
        { "field": "atc_sessions", "condition": "current >= 0" }
      ],
      "on_fail": {
        "action": "terminate",
        "reason": "Insufficient or invalid data for ATC rate analysis"
      },
      "next": "metric_decomposition"
    },

    {
      "id": "metric_decomposition",
      "type": "metric_compare",
      "metrics": ["orders", "sessions", "cvr", "atc_rate"],
      "next": "route_root_cause"
    },

    {
      "id": "route_root_cause",
      "type": "branch",
      "rules": [
        {
          "description": "Sessions stable (-5% to +5%) AND ATC rate dropped significantly",
          "all": [
            { "metric": "sessions_delta_pct", "op": ">", "value": -5 },
            { "metric": "sessions_delta_pct", "op": "<", "value": 5 },
            { "metric": "atc_rate_delta_pct", "op": "<", "value": -10 }
          ],
          "then": "landing_page_breakdown"
        }
      ],
      "default": {
        "then": "generic_insight"
      }
    },

    {
      "id": "landing_page_breakdown",
      "type": "recursive_dimension_breakdown",
      "dimensions": ["landing_page_path"],
      "base_metric": "atc_rate",
      "stop_conditions": {
        "max_depth": 1,
        "min_sessions": 50,
        "min_impact_pct": 5,
        "top_k": 5
      },
      "next": "final_insight"
    },

    {
      "id": "generic_insight",
      "type": "insight",
      "output_format": "structured_text",
      "template": {
        "summary": "ATC rate changed by {{atc_rate_delta_pct_fmt}} but sessions also changed by {{sessions_delta_pct_fmt}}. Does not match landing page mismatch pattern.",
        "details": [
          "Sessions changed by {{sessions_delta_pct_fmt}}",
          "ATC rate changed by {{atc_rate_delta_pct_fmt}}",
          "Orders changed by {{orders_delta_pct_fmt}}"
        ],
        "confidence": "{{confidence_score}}"
      },
      "persist": {
        "table": "alert_rca_results",
        "fields": ["alert_id", "summary", "confidence"]
      }
    },

    {
      "id": "final_insight",
      "type": "insight",
      "output_format": "structured_text",
      "template": {
        "summary": "Landing page mismatch detected: {{value}} has normal traffic but ATC dropped {{top_atc_rate_delta_pct_fmt}}.",
        "details": [
          "Landing page: {{value}}",
          "Sessions: {{top_baseline_sessions}} → {{top_current_sessions}} ({{top_sessions_delta_pct_fmt}})",
          "ATC sessions: {{top_baseline_atc_sessions}} → {{top_current_atc_sessions}}",
          "ATC rate: {{top_baseline_atc_rate_pct}} → {{top_current_atc_rate_pct}} ({{top_atc_rate_delta_pct_fmt}})",
          "Orders: {{top_baseline_orders}} → {{top_current_orders}}"
        ],
        "actions": [
          "Fix copy on landing page",
          "Fix CTA placement/visibility",
          "Remove conflicting links or distractions"
        ],
        "confidence": "{{confidence_score}}"
      },
      "persist": {
        "table": "alert_rca_results",
        "fields": ["alert_id", "summary", "confidence", "actions"]
      }
    }
  ]
}
